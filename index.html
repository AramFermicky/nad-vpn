<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NAD VPN ‚Äî WireGuard Controller</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <style>
        /* ===== –°—Ç–∏–ª–∏: –º–∏–Ω–∏–º—É–º, –Ω–æ –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }
        body { background: #f8fafc; color: #0f172a; transition: 0.2s; }
        body.dark { background: #0f172a; color: #e2e8f0; }
        .navbar { background: #1e293b; color: white; padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; }
        .nav-links { display: flex; gap: 0.5rem; list-style: none; }
        .nav-link { color: #cbd5e1; text-decoration: none; padding: 0.5rem 1rem; border-radius: 2rem; cursor: pointer; background: none; border: none; font-size: 0.9rem; }
        .nav-link.active { background: rgba(255,255,255,0.1); color: white; }
        .container { max-width: 600px; margin: 1.5rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 24px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #e2e8f0; }
        body.dark .card { background: #1e293b; border-color: #334155; }
        h2 { font-size: 1.5rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        textarea { width: 100%; padding: 1rem; border: 1px solid #cbd5e1; border-radius: 16px; font-family: monospace; resize: vertical; background: white; color: black; font-size: 0.9rem; }
        body.dark textarea { background: #0f172a; color: #e2e8f0; border-color: #475569; }
        input { padding: 0.75rem 1rem; border: 1px solid #cbd5e1; border-radius: 40px; font-size: 0.95rem; background: white; color: black; }
        body.dark input { background: #0f172a; color: white; border-color: #475569; }
        button { background: #2563eb; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 40px; font-weight: 600; cursor: pointer; transition: 0.1s; }
        button:hover { background: #1d4ed8; }
        button.danger { background: #dc2626; }
        button.danger:hover { background: #b91c1c; }
        button.small { padding: 0.4rem 1rem; font-size: 0.8rem; }
        .status-card { background: #f1f5f9; padding: 1.5rem; border-radius: 20px; text-align: center; font-size: 1.5rem; font-weight: bold; margin: 1rem 0; }
        body.dark .status-card { background: #0f172a; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
        .stat { background: #f8fafc; padding: 1rem; border-radius: 16px; text-align: center; }
        body.dark .stat { background: #0f172a; }
        .hidden { display: none !important; }
        .alert { padding: 1rem; border-radius: 12px; margin-top: 1rem; background: #fee2e2; color: #b91c1c; }
        .alert.success { background: #dcfce7; color: #166534; }
        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background: #f1f5f9; border-radius: 12px; margin-bottom: 0.5rem; }
        body.dark .config-item { background: #0f172a; }
        .peer-item { background: #f1f5f9; padding: 1rem; border-radius: 16px; margin-bottom: 0.75rem; }
        body.dark .peer-item { background: #0f172a; }
    </style>
</head>
<body>
    <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <nav class="navbar">
        <div class="logo">üîê NAD VPN</div>
        <ul class="nav-links">
            <li><button class="nav-link active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button></li>
            <li><button class="nav-link" data-page="dashboard">–î–∞—à–±–æ—Ä–¥</button></li>
            <li><button class="nav-link" data-page="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button></li>
            <li><button class="nav-link" data-page="about">–û –Ω–∞—Å</button></li>
        </ul>
    </nav>

    <main class="container">
        <!-- ========== –°–¢–†–ê–ù–ò–¶–ê: –ì–õ–ê–í–ù–ê–Ø ========== -->
        <div id="page-home">
            <div class="card">
                <h2>üîë –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h2>
                <textarea id="configInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é WireGuard (—Å–µ–∫—Ü–∏—è [Interface] –∏ [Peer])" rows="6"></textarea>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                    <input type="text" id="configName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –î–æ–º)" style="flex: 1;">
                    <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                </div>
                <div id="homeAlert" class="alert hidden"></div>
            </div>
            <div class="card">
                <h3>üìÅ –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h3>
                <ul id="savedList" style="list-style: none;"></ul>
                <p id="noConfigs" style="color: #64748b; text-align: center; margin-top: 1rem;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π</p>
            </div>
        </div>

        <!-- ========== –°–¢–†–ê–ù–ò–¶–ê: –î–ê–®–ë–û–†–î ========== -->
        <div id="page-dashboard" class="hidden">
            <div class="card">
                <h2>üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ VPN</h2>
                <div id="vpnStatus" class="status-card">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="stats-grid">
                    <div class="stat">
                        <span style="display: block; font-size: 0.8rem; color: #64748b;">‚¨áÔ∏è –ü–æ–ª—É—á–µ–Ω–æ</span>
                        <span id="rxValue" style="font-size: 1.5rem; font-weight: 700;">0 B</span>
                    </div>
                    <div class="stat">
                        <span style="display: block; font-size: 0.8rem; color: #64748b;">‚¨ÜÔ∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                        <span id="txValue" style="font-size: 1.5rem; font-weight: 700;">0 B</span>
                    </div>
                </div>
                <button id="disconnectBtn" class="danger" style="width: 100%;" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
            <div class="card">
                <h3>üîÑ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∏—Ä—ã</h3>
                <ul id="peersList" style="list-style: none;"></ul>
            </div>
        </div>

        <!-- ========== –°–¢–†–ê–ù–ò–¶–ê: –ù–ê–°–¢–†–û–ô–ö–ò ========== -->
        <div id="page-settings" class="hidden">
            <div class="card">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #e2e8f0;">
                    <span>üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                    <button id="themeToggle" class="small">–í–∫–ª—é—á–∏—Ç—å</button>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #e2e8f0;">
                    <span>üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</span>
                    <button id="clearConfigsBtn" class="small danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <div style="padding: 1rem 0;">
                    <span>üîó –ê–¥—Ä–µ—Å API: </span>
                    <span id="apiEndpoint" style="font-family: monospace; background: #f1f5f9; padding: 0.2rem 0.5rem; border-radius: 8px;"></span>
                </div>
            </div>
        </div>

        <!-- ========== –°–¢–†–ê–ù–ò–¶–ê: –û –ù–ê–° ========== -->
        <div id="page-about" class="hidden">
            <div class="card">
                <h2>‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h2>
                <p style="margin-bottom: 0.5rem;"><strong>NAD VPN</strong> ‚Äî Native Application in Device.</p>
                <p style="margin-bottom: 0.5rem;">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ WireGuard —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä—è–º–æ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, —Å–º–æ—Ç—Ä–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—Ä–∞—Ñ–∏–∫–∞.</p>
                <p>–í–µ—Ä—Å–∏—è: 2.0.1 (SPA + PWA)</p>
                <p style="margin-top: 1rem;">–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è GitHub</p>
            </div>
        </div>
    </main>

    <script>
        // ============================================
        // NAD VPN ‚Äî –ï–î–ò–ù–´–ô SPA-–ö–û–î
        // ============================================

        // ========== –í–ê–® –†–ï–ê–õ–¨–ù–´–ô –î–û–ú–ï–ù ==========
        const API_BASE = 'https://aramfermicky.github.io/nad-vpn/';   
        
        // =========================================

        // ---------- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ----------
        let currentTheme = localStorage.getItem('theme') || 'light';
        let savedConfigs = JSON.parse(localStorage.getItem('nad_configs') || '{}');

        // ---------- DOM-—ç–ª–µ–º–µ–Ω—Ç—ã ----------
        const pages = {
            home: document.getElementById('page-home'),
            dashboard: document.getElementById('page-dashboard'),
            settings: document.getElementById('page-settings'),
            about: document.getElementById('page-about')
        };
        const navLinks = document.querySelectorAll('.nav-link');
        const configInput = document.getElementById('configInput');
        const configName = document.getElementById('configName');
        const connectBtn = document.getElementById('connectBtn');
        const homeAlert = document.getElementById('homeAlert');
        const savedList = document.getElementById('savedList');
        const noConfigs = document.getElementById('noConfigs');
        const vpnStatus = document.getElementById('vpnStatus');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const rxValue = document.getElementById('rxValue');
        const txValue = document.getElementById('txValue');
        const peersList = document.getElementById('peersList');
        const themeToggle = document.getElementById('themeToggle');
        const clearConfigsBtn = document.getElementById('clearConfigsBtn');
        const apiEndpoint = document.getElementById('apiEndpoint');

        // ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----------
        function init() {
            applyTheme(currentTheme);
            renderSavedConfigs();
            setupEventListeners();
            showPage('home');
            apiEndpoint.textContent = API_BASE;
        }

        // ---------- –ù–∞–≤–∏–≥–∞—Ü–∏—è ----------
        function showPage(pageId) {
            Object.values(pages).forEach(p => p.classList.add('hidden'));
            if (pages[pageId]) pages[pageId].classList.remove('hidden');
            navLinks.forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageId);
            });
            if (pageId === 'dashboard') {
                fetchStatus();
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        // ---------- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞ ----------
        let refreshInterval = null;
        function startAutoRefresh() { stopAutoRefresh(); refreshInterval = setInterval(fetchStatus, 3000); }
        function stopAutoRefresh() { if (refreshInterval) clearInterval(refreshInterval); refreshInterval = null; }

        // ---------- –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ----------
        function renderSavedConfigs() {
            const entries = Object.entries(savedConfigs);
            if (entries.length === 0) {
                savedList.innerHTML = '';
                noConfigs.style.display = 'block';
                return;
            }
            noConfigs.style.display = 'none';
            savedList.innerHTML = entries.map(([name, cfg]) => `
                <li class="config-item">
                    <span style="font-weight: 500;">${escapeHTML(name)}</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="small" onclick="window.useConfig('${escapeHTML(name)}')">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                        <button class="small danger" onclick="window.deleteConfig('${escapeHTML(name)}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </li>
            `).join('');
        }
        window.useConfig = function(name) {
            configInput.value = savedConfigs[name];
            configName.value = name;
            showPage('home');
        };
        window.deleteConfig = function(name) {
            delete savedConfigs[name];
            localStorage.setItem('nad_configs', JSON.stringify(savedConfigs));
            renderSavedConfigs();
        };
        function saveConfigToStorage(name, config) {
            savedConfigs[name] = config;
            localStorage.setItem('nad_configs', JSON.stringify(savedConfigs));
            renderSavedConfigs();
        }
        function clearAllConfigs() {
            savedConfigs = {};
            localStorage.removeItem('nad_configs');
            renderSavedConfigs();
        }
        function escapeHTML(str) {
            return String(str).replace(/[&<>"]/g, function(c) {
                if (c === '&') return '&amp;';
                if (c === '<') return '&lt;';
                if (c === '>') return '&gt;';
                if (c === '"') return '&quot;';
                return c;
            });
        }

        // ---------- API-–∑–∞–ø—Ä–æ—Å—ã ----------
        async function apiFetch(endpoint, options = {}) {
            const url = API_BASE + endpoint;
            const res = await fetch(url, {
                ...options,
                headers: { 'Content-Type': 'application/json', ...options.headers }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }

        // ---------- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ----------
        connectBtn.addEventListener('click', async () => {
            const config = configInput.value.trim();
            const name = configName.value.trim() || `config-${Date.now()}`;
            if (!config) return showAlert('‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—É—Å—Ç–∞', 'error');
            showAlert('‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
            try {
                const data = await apiFetch('/api/connect', { method: 'POST', body: JSON.stringify({ config, name }) });
                if (data.success) {
                    showAlert('‚úÖ VPN –ø–æ–¥–∫–ª—é—á—ë–Ω', 'success');
                    saveConfigToStorage(name, config);
                } else {
                    showAlert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API_BASE –∏ CORS.', 'error');
            }
        });

        function showAlert(msg, type) {
            homeAlert.textContent = msg;
            homeAlert.className = `alert ${type === 'success' ? 'success' : ''}`;
            homeAlert.classList.remove('hidden');
            setTimeout(() => homeAlert.classList.add('hidden'), 5000);
        }

        // ---------- –°—Ç–∞—Ç—É—Å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ----------
        async function fetchStatus() {
            try {
                const data = await apiFetch('/api/status');
                if (data.connected) {
                    vpnStatus.innerHTML = '‚úÖ VPN –∞–∫—Ç–∏–≤–µ–Ω';
                    disconnectBtn.disabled = false;
                    rxValue.textContent = formatBytes(data.transfer?.received || 0);
                    txValue.textContent = formatBytes(data.transfer?.sent || 0);
                    if (data.peers && data.peers.length) {
                        peersList.innerHTML = data.peers.map(p => `
                            <li class="peer-item">
                                <span style="font-family: monospace; color: #2563eb;">${p.public_key?.slice(0,16) || '??'}‚Ä¶</span>
                                <span style="display: block; font-size: 0.9rem;">üì° ${p.endpoint || '‚Äî'}</span>
                                <span style="display: block; font-size: 0.8rem; color: #64748b;">‚¨áÔ∏è ${formatBytes(p.transfer?.rx || 0)} / ‚¨ÜÔ∏è ${formatBytes(p.transfer?.tx || 0)}</span>
                            </li>
                        `).join('');
                    } else {
                        peersList.innerHTML = '<li style="color: #64748b; text-align: center;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∏—Ä–æ–≤</li>';
                    }
                } else {
                    vpnStatus.innerHTML = '‚ùå VPN –æ—Ç–∫–ª—é—á—ë–Ω';
                    disconnectBtn.disabled = true;
                    rxValue.textContent = '0 B';
                    txValue.textContent = '0 B';
                    peersList.innerHTML = '<li style="color: #64748b; text-align: center;">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</li>';
                }
            } catch {
                vpnStatus.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å API';
                disconnectBtn.disabled = true;
            }
        }

        // ---------- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ ----------
        disconnectBtn.addEventListener('click', async () => {
            await apiFetch('/api/disconnect', { method: 'POST' });
            fetchStatus();
        });

        // ---------- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–π—Ç–æ–≤ ----------
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KiB', 'MiB', 'GiB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // ---------- –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ ----------
        themeToggle.addEventListener('click', toggleTheme);
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(currentTheme);
        }
        function applyTheme(theme) {
            document.body.className = theme;
            localStorage.setItem('theme', theme);
            themeToggle.textContent = theme === 'dark' ? '–í—ã–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å';
        }

        // ---------- –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π ----------
        clearConfigsBtn.addEventListener('click', () => {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏?')) {
                clearAllConfigs();
            }
        });

        // ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ----------
        function setupEventListeners() {
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(link.dataset.page);
                });
            });
        }

        // ---------- –ó–∞–ø—É—Å–∫ ----------
        init();
    </script>
</body>
</html>