<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NAD VPN ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WireGuard</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <style>
        /* ===== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Å–±—Ä–æ—Å ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --text-secondary: #334155;
            --border: #e2e8f0;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #dc2626;
            --danger-hover: #b91c1c;
            --success: #10b981;
            --warning: #f59e0b;
            --navbar-bg: #1e293b;
            --navbar-text: #f1f5f9;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        }

        .theme-dark {
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --navbar-bg: #0a0f1c;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.2s, color 0.2s;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è ===== */
        .navbar {
            background-color: var(--navbar-bg);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(8px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .logo {
            font-weight: 700;
            font-size: 1.35rem;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            list-style: none;
        }

        .nav-link {
            color: #cbd5e1;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.15s;
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        /* ===== –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ===== */
        .container {
            max-width: 600px;
            margin: 1.5rem auto;
            padding: 0 1rem;
            width: 100%;
            flex: 1;
        }

        /* ===== –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ —Å–µ–∫—Ü–∏–∏ ===== */
        .card {
            background: var(--surface);
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ===== –§–æ—Ä–º—ã ===== */
        textarea {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 16px;
            background: var(--bg);
            color: var(--text);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 0.75rem;
        }

        .input-group {
            display: flex;
            gap: 0.75rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .input-group input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 40px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.95rem;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.15s, opacity 0.15s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:hover {
            background: var(--primary-hover);
        }

        button.danger {
            background: var(--danger);
        }
        button.danger:hover {
            background: var(--danger-hover);
        }

        button.small {
            padding: 0.4rem 1rem;
            font-size: 0.8rem;
        }

        button:disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* ===== –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π ===== */
        .config-list {
            list-style: none;
            margin-top: 1rem;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg);
            border-radius: 16px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
        }

        /* ===== –î–∞—à–±–æ—Ä–¥ ===== */
        .status-card {
            background: var(--bg);
            padding: 1.75rem;
            border-radius: 24px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 1rem 0;
            border: 1px solid var(--border);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat {
            background: var(--bg);
            padding: 1.25rem;
            border-radius: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat .label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.35rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat .value {
            font-size: 1.35rem;
            font-weight: 700;
        }

        .peer-list {
            list-style: none;
            margin-top: 1rem;
        }
        .peer-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 16px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        .peer-pubkey {
            font-family: monospace;
            font-size: 0.8rem;
            word-break: break-all;
            color: var(--primary);
        }

        /* ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===== */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }
        .setting-item:last-child {
            border-bottom: none;
        }

        /* ===== –£—Ç–∏–ª–∏—Ç—ã ===== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 12px;
            background: #fee2e2;
            color: #b91c1c;
            margin-top: 1rem;
        }
        .theme-dark .alert {
            background: #451a1a;
            color: #fecaca;
        }
        .alert.success {
            background: #dcfce7;
            color: #166534;
        }
        .theme-dark .alert.success {
            background: #14532d;
            color: #bbf7d0;
        }

        /* ===== –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö ===== */
        @media (max-width: 480px) {
            .navbar { padding: 0.5rem 0.75rem; }
            .nav-link { padding: 0.4rem 0.75rem; }
            .container { padding: 0 0.75rem; }
            h2 { font-size: 1.35rem; }
        }
    </style>
</head>
<body class="theme-light">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar">
        <div class="logo">üîê NAD</div>
        <ul class="nav-links">
            <li><button class="nav-link" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button></li>
            <li><button class="nav-link" data-page="dashboard">–î–∞—à–±–æ—Ä–¥</button></li>
            <li><button class="nav-link" data-page="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button></li>
            <li><button class="nav-link" data-page="about">–û –Ω–∞—Å</button></li>
        </ul>
    </nav>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü -->
    <main class="container">
        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞: –ì–ª–∞–≤–Ω–∞—è (–≤–≤–æ–¥ –∫–ª—é—á–∞) -->
        <div id="page-home" class="page">
            <div class="card">
                <h2>üîë –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h2>
                <textarea id="configInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é WireGuard (—Å–µ–∫—Ü–∏—è [Interface] –∏ [Peer])" rows="8"></textarea>
                <div class="input-group">
                    <input type="text" id="configName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –î–æ–º)">
                    <button id="connectBtn" class="primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                </div>
                <div id="homeStatus" class="alert hidden"></div>
            </div>

            <div class="card">
                <h3>üìÅ –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h3>
                <ul id="savedConfigsList" class="config-list">
                    <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç -->
                </ul>
                <p id="noConfigsMsg" class="text-center text-secondary" style="color: var(--text-secondary);">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π</p>
            </div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞: –î–∞—à–±–æ—Ä–¥ -->
        <div id="page-dashboard" class="page hidden">
            <div class="card">
                <h2>üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ VPN</h2>
                <div id="vpnStatus" class="status-card">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="stats-grid">
                    <div class="stat">
                        <span class="label">‚¨áÔ∏è –ü–æ–ª—É—á–µ–Ω–æ</span>
                        <span id="rxValue" class="value">0 B</span>
                    </div>
                    <div class="stat">
                        <span class="label">‚¨ÜÔ∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                        <span id="txValue" class="value">0 B</span>
                    </div>
                </div>
                <button id="disconnectBtn" class="danger" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
            <div class="card">
                <h3>üîÑ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∏—Ä—ã</h3>
                <ul id="peersList" class="peer-list">
                    <li class="text-center" style="color: var(--text-secondary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>
                </ul>
            </div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div id="page-settings" class="page hidden">
            <div class="card">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <div class="setting-item">
                    <span>üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                    <button id="themeToggle" class="small">–í–∫–ª—é—á–∏—Ç—å</button>
                </div>
                <div class="setting-item">
                    <span>üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</span>
                    <button id="clearConfigsBtn" class="small danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <div class="setting-item">
                    <span>üîó –ê–¥—Ä–µ—Å API</span>
                    <span id="apiEndpointDisplay" style="font-family: monospace;">https://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä.ru</span>
                </div>
            </div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞: –û –Ω–∞—Å -->
        <div id="page-about" class="page hidden">
            <div class="card">
                <h2>‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h2>
                <p style="margin-bottom: 1rem;"><strong>NAD VPN</strong> ‚Äî Native Application in Device.</p>
                <p>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ WireGuard —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä—è–º–æ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, —Å–º–æ—Ç—Ä–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—Ä–∞—Ñ–∏–∫–∞.</p>
                <p style="margin-top: 1.5rem;">–í–µ—Ä—Å–∏—è: 2.0.0 (SPA)</p>
                <p>–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è GitHub</p>
            </div>
        </div>
    </main>

    <script>
        // ============================================
        // NAD VPN ‚Äî SPA —Å –µ–¥–∏–Ω—ã–º HTML
        // ============================================

        // ---------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API ----------
        const API_BASE = 'https://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä.ru'; // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –î–û–ú–ï–ù

        // ---------- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ----------
        let currentTheme = localStorage.getItem('theme') || 'light';
        let savedConfigs = {};

        // ---------- DOM-—ç–ª–µ–º–µ–Ω—Ç—ã (–∫—ç—à–∏—Ä—É–µ–º) ----------
        const pages = {
            home: document.getElementById('page-home'),
            dashboard: document.getElementById('page-dashboard'),
            settings: document.getElementById('page-settings'),
            about: document.getElementById('page-about')
        };
        const navLinks = document.querySelectorAll('.nav-link');
        const configInput = document.getElementById('configInput');
        const configName = document.getElementById('configName');
        const connectBtn = document.getElementById('connectBtn');
        const homeStatus = document.getElementById('homeStatus');
        const savedList = document.getElementById('savedConfigsList');
        const noConfigsMsg = document.getElementById('noConfigsMsg');
        const vpnStatus = document.getElementById('vpnStatus');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const rxValue = document.getElementById('rxValue');
        const txValue = document.getElementById('txValue');
        const peersList = document.getElementById('peersList');
        const themeToggle = document.getElementById('themeToggle');
        const clearConfigsBtn = document.getElementById('clearConfigsBtn');
        const apiEndpointDisplay = document.getElementById('apiEndpointDisplay');

        // ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----------
        function init() {
            loadSavedConfigs();
            renderSavedConfigs();
            applyTheme(currentTheme);
            setupEventListeners();
            showPage('home'); // –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
            if (apiEndpointDisplay) apiEndpointDisplay.textContent = API_BASE;
        }

        // ---------- –ù–∞–≤–∏–≥–∞—Ü–∏—è (SPA) ----------
        function showPage(pageId) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            Object.values(pages).forEach(p => p.classList.add('hidden'));
            // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—É—é
            if (pages[pageId]) pages[pageId].classList.remove('hidden');
            // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            navLinks.forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageId);
            });
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –¥–∞—à–±–æ—Ä–¥ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            if (pageId === 'dashboard') {
                fetchStatus();
                startDashboardAutoRefresh();
            } else {
                stopDashboardAutoRefresh();
            }
        }

        // ---------- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞ ----------
        let dashboardInterval = null;
        function startDashboardAutoRefresh() {
            if (dashboardInterval) clearInterval(dashboardInterval);
            dashboardInterval = setInterval(fetchStatus, 3000);
        }
        function stopDashboardAutoRefresh() {
            if (dashboardInterval) {
                clearInterval(dashboardInterval);
                dashboardInterval = null;
            }
        }

        // ---------- –†–∞–±–æ—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥–∞–º–∏ (localStorage) ----------
        const STORAGE_KEY = 'nad_saved_configs_v2';
        function loadSavedConfigs() {
            const raw = localStorage.getItem(STORAGE_KEY);
            savedConfigs = raw ? JSON.parse(raw) : {};
        }
        function saveConfigToStorage(name, config) {
            savedConfigs[name] = config;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedConfigs));
            renderSavedConfigs();
        }
        function deleteConfigFromStorage(name) {
            delete savedConfigs[name];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedConfigs));
            renderSavedConfigs();
        }
        function clearAllConfigs() {
            savedConfigs = {};
            localStorage.removeItem(STORAGE_KEY);
            renderSavedConfigs();
        }

        // ---------- –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π ----------
        function renderSavedConfigs() {
            const entries = Object.entries(savedConfigs);
            if (entries.length === 0) {
                savedList.innerHTML = '';
                noConfigsMsg.classList.remove('hidden');
                return;
            }
            noConfigsMsg.classList.add('hidden');
            savedList.innerHTML = entries.map(([name, config]) => `
                <li class="config-item">
                    <span style="font-weight: 500;">${escapeHTML(name)}</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="small use-config" data-name="${escapeHTML(name)}">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                        <button class="small danger delete-config" data-name="${escapeHTML(name)}">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </li>
            `).join('');

            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
            savedList.querySelectorAll('.use-config').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const name = e.currentTarget.dataset.name;
                    const config = savedConfigs[name];
                    if (config) {
                        configInput.value = config;
                        configName.value = name;
                        showPage('home');
                    }
                });
            });
            savedList.querySelectorAll('.delete-config').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const name = e.currentTarget.dataset.name;
                    deleteConfigFromStorage(name);
                });
            });
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
        function escapeHTML(str) {
            return str.replace(/[&<>"]/g, function(m) {
                if (m === '&') return '&amp;';
                if (m === '<') return '&lt;';
                if (m === '>') return '&gt;';
                if (m === '"') return '&quot;';
                return m;
            });
        }

        // ---------- API-–∑–∞–ø—Ä–æ—Å—ã ----------
        async function apiFetch(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const res = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        // ---------- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VPN ----------
        async function handleConnect(config, name) {
            showHomeMessage('‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
            try {
                const data = await apiFetch('/api/connect', {
        